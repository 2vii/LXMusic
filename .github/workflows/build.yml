name: Build IPA
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Podfile
        run: |
          echo "
          platform :ios, '15.0'
          use_frameworks!
          target 'LXMusic' do
            pod 'Alamofire'
            pod 'SwiftyJSON'
            pod 'Cache'
          end
          " > Podfile

      - name: Install Pods
        run: pod install

      - name: Create Xcode Project
        run: |
          xcodebuild -create-xcproject \
            -project LXMusic.xcodeproj \
            -target LXMusic \
            -platform iOS \
            -language Swift \
            -ui SwiftUI

      - name: Build Archive
        run: |
          xcodebuild archive \
            -project LXMusic.xcodeproj \
            -scheme LXMusic \
            -destination generic/platform=iOS \
            -archivePath output.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath output.xcarchive \
            -exportPath . \
            -exportOptionsPlist <(echo '{"signingStyle":"none"}') \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - uses: actions/upload-artifact@v4
        with:
          name: Final-IPA
          path: ./*.ipa
